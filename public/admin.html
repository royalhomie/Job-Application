<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Job Applications</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            color: #333;
        }

        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .dashboard-header h1 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .dashboard-header p {
            opacity: 0.9;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 1.1rem;
        }

        .applications-section {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .section-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 1.5rem;
            color: #333;
        }

        .search-filter {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .search-input,
        .filter-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .applications-table {
            width: 100%;
            border-collapse: collapse;
        }

        .applications-table th,
        .applications-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .applications-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }

        .applications-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-new {
            background: #e3f2fd;
            color: #1976d2;
        }

        .status-reviewing {
            background: #fff3e0;
            color: #f57c00;
        }

        .status-contacted {
            background: #e8f5e8;
            color: #388e3c;
        }

        .status-rejected {
            background: #ffebee;
            color: #d32f2f;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .application-detail {
            margin-bottom: 15px;
        }

        .application-detail label {
            font-weight: 600;
            color: #555;
            display: block;
            margin-bottom: 5px;
        }

        .application-detail .value {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            border-left: 3px solid #667eea;
        }

        .no-applications {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        @media (max-width: 768px) {
            .search-filter {
                flex-direction: column;
                align-items: stretch;
            }

            .applications-table {
                font-size: 0.9rem;
            }

            .applications-table th,
            .applications-table td {
                padding: 10px 8px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #dc3545;
            background: #ffebee;
            border-radius: 5px;
        }
    </style>
</head>

<body>
    <div class="dashboard-header">
        <div class="container">
            <h1>ðŸ“Š Admin Dashboard</h1>
            <p>Manage job applications and track recruitment progress</p>
        </div>
    </div>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalApplications">-</div>
                <div class="stat-label">Total Applications</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="newApplications">-</div>
                <div class="stat-label">New Applications</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="reviewingApplications">-</div>
                <div class="stat-label">Under Review</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todayApplications">-</div>
                <div class="stat-label">Today's Applications</div>
            </div>
        </div>

        <div class="applications-section">
            <div class="section-header">
                <h2 class="section-title">Recent Applications</h2>
                <div class="search-filter">
                    <input type="text" class="search-input" id="searchInput" placeholder="Search applications...">
                    <select class="filter-select" id="positionFilter">
                        <option value="">All Positions</option>
                        <option value="Software Developer">Software Developer</option>
                        <option value="Marketing Specialist">Marketing Specialist</option>
                        <option value="Sales Representative">Sales Representative</option>
                        <option value="Customer Service">Customer Service</option>
                        <option value="Project Manager">Project Manager</option>
                        <option value="Data Analyst">Data Analyst</option>
                        <option value="Other">Other</option>
                    </select>
                    <select class="filter-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="new">New</option>
                        <option value="reviewing">Reviewing</option>
                        <option value="contacted">Contacted</option>
                        <option value="rejected">Rejected</option>
                    </select>
                </div>
            </div>

            <div id="applicationsTableContainer">
                <div class="loading">
                    <p>Loading applications...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for viewing application details -->
    <div id="applicationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Application Details</h3>
                <span class="close">&times;</span>
            </div>
            <div id="applicationDetails">
                <!-- Application details will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // Check if user is logged in
        const token = localStorage.getItem('adminToken');
        if (!token) {
            window.location.href = '/login.html';
        }

        // Add token to all fetch requests
        async function fetchWithAuth(url, options = {}) {
            const token = localStorage.getItem('adminToken');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }

            const headers = {
                ...options.headers,
                'Authorization': `Bearer ${token}`
            };

            try {
                const response = await fetch(url, { ...options, headers });
                if (response.status === 401) {
                    // Token expired or invalid
                    localStorage.removeItem('adminToken');
                    window.location.href = '/login.html';
                    return;
                }
                return response;
            } catch (error) {
                console.error('Error:', error);
                throw error;
            }
        }

        // Global applications array - will be populated from API
        let applications = [];

        // DOM elements
        const searchInput = document.getElementById('searchInput');
        const positionFilter = document.getElementById('positionFilter');
        const statusFilter = document.getElementById('statusFilter');
        const applicationsTableContainer = document.getElementById('applicationsTableContainer');
        const modal = document.getElementById('applicationModal');
        const closeModal = document.querySelector('.close');

        // Initialize dashboard
        async function initDashboard() {
            await loadApplications();
            updateStats();
            renderApplicationsTable();
            setupEventListeners();
        }

        // Load applications from API
        async function loadApplications() {
            try {
                const response = await fetchWithAuth('/api/applications');
                const data = await response.json();

                if (data.success) {
                    applications = data.applications;
                    console.log(`Loaded ${applications.length} applications`);
                } else {
                    console.error('Failed to load applications:', data.message);
                    applications = [];
                }
            } catch (error) {
                console.error('Error loading applications:', error);
                applications = [];
            }
        }

        // Refresh applications data
        async function refreshApplications() {
            await loadApplications();
            updateStats();
            renderApplicationsTable();
        }

        // Update statistics
        function updateStats() {
            const total = applications.length;
            const newApps = applications.filter(app => app.status === 'new').length;
            const reviewing = applications.filter(app => app.status === 'reviewing').length;
            const today = applications.filter(app => {
                const appDate = new Date(app.timestamp);
                const todayDate = new Date();
                return appDate.toDateString() === todayDate.toDateString();
            }).length;

            document.getElementById('totalApplications').textContent = total;
            document.getElementById('newApplications').textContent = newApps;
            document.getElementById('reviewingApplications').textContent = reviewing;
            document.getElementById('todayApplications').textContent = today;
        }

        // Render applications table
        function renderApplicationsTable(filteredApplications = applications) {
            if (filteredApplications.length === 0) {
                applicationsTableContainer.innerHTML = `
                    <div class="no-applications" style="text-align: center; padding: 40px; color: #666;">
                        <p>No applications found matching your criteria.</p>
                        <button onclick="refreshApplications()" class="btn btn-primary" style="margin-top: 10px;">Refresh</button>
                    </div>
                `;
                return;
            }

            const tableHTML = `
                <table class="applications-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Position</th>
                            <th>Email</th>
                            <th>Experience</th>
                            <th>Status</th>
                            <th>Submitted</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredApplications.map(app => `
                            <tr>
                                <td>${app.firstName || ''} ${app.lastName || ''}</td>
                                <td>${app.position || 'Not specified'}</td>
                                <td>${app.email || 'Not provided'}</td>
                                <td>${app.experience || 'Not specified'}</td>
                                <td><span class="status-badge status-${app.status}">${capitalizeFirst(app.status)}</span></td>
                                <td>${formatDate(app.timestamp)}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-primary" onclick="viewApplication('${app.id}')">View</button>
                                        <button class="btn btn-success" onclick="updateStatus('${app.id}', 'contacted')">Contact</button>
                                        <button class="btn btn-danger" onclick="updateStatus('${app.id}', 'rejected')">Reject</button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            applicationsTableContainer.innerHTML = tableHTML;
        }

        // Setup event listeners
        function setupEventListeners() {
            searchInput.addEventListener('input', filterApplications);
            positionFilter.addEventListener('change', filterApplications);
            statusFilter.addEventListener('change', filterApplications);

            closeModal.addEventListener('click', () => {
                modal.style.display = 'none';
            });

            window.addEventListener('click', (event) => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });

            // Add refresh button functionality
            const refreshBtn = document.createElement('button');
            refreshBtn.className = 'btn btn-primary';
            refreshBtn.textContent = 'ðŸ”„ Refresh';
            refreshBtn.onclick = refreshApplications;
            refreshBtn.style.marginLeft = '10px';

            const sectionHeader = document.querySelector('.section-header');
            if (sectionHeader) {
                sectionHeader.appendChild(refreshBtn);
            }
        }

        // Filter applications
        function filterApplications() {
            const searchTerm = searchInput.value.toLowerCase();
            const positionFilter = document.getElementById('positionFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            const filtered = applications.filter(app => {
                const matchesSearch = !searchTerm ||
                    (app.firstName && app.firstName.toLowerCase().includes(searchTerm)) ||
                    (app.lastName && app.lastName.toLowerCase().includes(searchTerm)) ||
                    (app.email && app.email.toLowerCase().includes(searchTerm)) ||
                    (app.position && app.position.toLowerCase().includes(searchTerm));

                const matchesPosition = !positionFilter || app.position === positionFilter;
                const matchesStatus = !statusFilter || app.status === statusFilter;

                return matchesSearch && matchesPosition && matchesStatus;
            });

            renderApplicationsTable(filtered);
        }

        // View application details
        async function viewApplication(applicationId) {
            try {
                const response = await fetch(`/api/applications/${applicationId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const data = await response.json();

                if (data.success) {
                    const application = data.application;
                    const modalContent = `
                        <div class="application-details">
                            <h3>Application Details</h3>
                            <div class="detail-row">
                                <strong>Name:</strong> ${application.firstName} ${application.lastName}
                            </div>
                            <div class="detail-row">
                                <strong>Email:</strong> ${application.email}
                            </div>
                            <div class="detail-row">
                                <strong>Phone:</strong> ${application.phone}
                            </div>
                            <div class="detail-row">
                                <strong>Position:</strong> ${application.position}
                            </div>
                            <div class="detail-row">
                                <strong>Experience:</strong> ${application.experience}
                            </div>
                            <div class="detail-row">
                                <strong>Expected Salary:</strong> ${application.expectedSalary}
                            </div>
                            <div class="detail-row">
                                <strong>Availability:</strong> ${application.availability}
                            </div>
                            <div class="detail-row">
                                <strong>LinkedIn:</strong> ${application.linkedin || 'Not provided'}
                            </div>
                            <div class="detail-row">
                                <strong>Portfolio:</strong> ${application.portfolio || 'Not provided'}
                            </div>
                            <div class="detail-row">
                                <strong>Source:</strong> ${application.source || 'Not provided'}
                            </div>
                            <div class="detail-row">
                                <strong>Cover Letter:</strong> ${application.coverLetter || 'Not provided'}
                            </div>
                            ${application.resume ? `
                                <div class="detail-row">
                                    <strong>Resume:</strong> 
                                    <a href="/uploads/${application.resume}" target="_blank" class="btn btn-sm btn-primary">Download Resume</a>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    showModal("Application Details", modalContent);
                } else {
                    alert("Error loading application details");
                }
            } catch (error) {
                console.error("Error:", error);
                alert("Error loading application details");
            }
        }

        // Update application status
        function updateStatus(applicationId, newStatus) {
            const app = applications.find(a => a.id === applicationId);
            if (app) {
                app.status = newStatus;
                updateStats();
                filterApplications(); // Re-render with current filters

                // In a real application, you would make an API call here
                console.log(`Updated application ${applicationId} status to ${newStatus}`);
            }
        }

        // Utility functions
        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function formatDate(dateString) {
            if (!dateString) return 'Not available';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', initDashboard);

        // Auto-refresh applications every 30 seconds
        setInterval(() => {
            refreshApplications();
        }, 30000); // Update every 30 seconds

        // Add logout functionality
        function logout() {
            localStorage.removeItem('adminToken');
            window.location.href = '/login.html';
        }

        // Add logout button to your HTML
        document.addEventListener('DOMContentLoaded', function () {
            const header = document.querySelector('.header');
            const logoutButton = document.createElement('button');
            logoutButton.className = 'btn btn-danger';
            logoutButton.innerHTML = 'Logout';
            logoutButton.onclick = logout;
            header.appendChild(logoutButton);
        });

        // Add these functions after your existing JavaScript code
        async function contactApplicant(applicationId) {
            try {
                const response = await fetch(`/api/applications/${applicationId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const data = await response.json();

                if (data.success) {
                    const application = data.application;
                    const modalContent = `
                        <form id="contactForm" onsubmit="handleContactSubmit(event, '${applicationId}')">
                            <div class="form-group">
                                <label>To:</label>
                                <input type="email" class="form-control" value="${application.email}" readonly>
                            </div>
                            <div class="form-group">
                                <label>Subject:</label>
                                <input type="text" class="form-control" name="subject" required>
                            </div>
                            <div class="form-group">
                                <label>Message:</label>
                                <textarea class="form-control" name="message" rows="5" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Send Email</button>
                        </form>
                    `;
                    showModal("Contact Applicant", modalContent);
                } else {
                    alert("Error loading application details");
                }
            } catch (error) {
                console.error("Error:", error);
                alert("Error loading application details");
            }
        }

        async function rejectApplication(applicationId) {
            if (confirm("Are you sure you want to reject this application?")) {
                try {
                    const response = await fetch("/api/reject-application", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({ applicationId })
                    });

                    const data = await response.json();
                    if (data.success) {
                        alert("Application rejected successfully");
                        loadApplications(); // Refresh the list
                    } else {
                        alert(data.message || "Error rejecting application");
                    }
                } catch (error) {
                    console.error("Error:", error);
                    alert("Error rejecting application");
                }
            }
        }

        // Add the handleContactSubmit function
        async function handleContactSubmit(event, applicationId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            try {
                const response = await fetch("/api/contact-applicant", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        applicationId,
                        subject: formData.get("subject"),
                        message: formData.get("message")
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert("Email sent successfully");
                    closeModal();
                } else {
                    alert(data.message || "Error sending email");
                }
            } catch (error) {
                console.error("Error:", error);
                alert("Error sending email");
            }
        }

        // Update the displayApplications function
        function displayApplications(applications) {
            const tbody = document.getElementById("applicationsTableBody");
            tbody.innerHTML = "";

            applications.forEach(app => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${app.firstName} ${app.lastName}</td>
                    <td>${app.position}</td>
                    <td>${app.email}</td>
                    <td>${app.experience}</td>
                    <td>${app.status || "New"}</td>
                    <td>${new Date(app.submittedAt).toLocaleString()}</td>
                    <td class="action-buttons">
                        <button onclick="viewApplication('${app._id}')" class="btn btn-info btn-sm">View</button>
                        <button onclick="contactApplicant('${app._id}')" class="btn btn-primary btn-sm">Contact</button>
                        <button onclick="rejectApplication('${app._id}')" class="btn btn-danger btn-sm">Reject</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
    </script>
</body>

</html>